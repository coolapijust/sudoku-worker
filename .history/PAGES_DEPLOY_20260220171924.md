# Cloudflare Pages 部署指南

由于 Cloudflare Worker Dashboard 不支持直接上传 WASM 模块，使用 **Cloudflare Pages** 是更好的选择。Pages Functions 支持 WASM 模块绑定。

---

## 方式一：通过 Git 集成部署（推荐）

### 步骤 1：准备仓库

确保 GitHub 仓库包含以下文件：

```
sudoku-worker/
├── functions/
│   └── api/
│       └── stream.ts       # WebSocket 端点
├── static/                 # 静态文件目录（Output directory）
│   └── index.html          # 研究站伪装页面（已存在）
├── sudoku.wasm             # WASM 模块
├── wrangler.toml           # Pages 配置
├── package.json
└── index.html              # 项目根目录的研究站页面
```

> **重要**: 我们已经有完整的伪装前端 `index.html`，需要复制到 `static/` 目录用于 Pages 部署。

### 步骤 2：创建 Pages 配置文件

创建 `wrangler.toml`（Pages 版本）：

```toml
name = "sudoku-wasm-pages"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# WASM 模块绑定
[[wasm_modules]]
binding = "SUDOKU_WASM"
module = "./sudoku.wasm"

[vars]
UPSTREAM_HOST = "127.0.0.1"
UPSTREAM_PORT = "8080"
CIPHER_METHOD = "chacha20-poly1305"
LAYOUT_MODE = "ascii"
KEY_DERIVE_SALT = "sudoku-v2-edge-salt"
ED25519_PUBLIC_KEY = ""
```

### 步骤 3：创建 Functions 入口

创建 `functions/api/stream.ts`（已为您准备好）：

**主要修改点**（相比 Worker 版本）：

1. **路由方式不同**:
   - Worker: 使用 `export default { fetch }` 处理所有路由
   - Pages: 使用文件系统路由，`functions/api/stream.ts` 自动对应 `/api/stream` 路径

2. **WASM 绑定方式**:
   - Worker: `env.SUDOKU_WASM` 是模块绑定
   - Pages: `env.SUDOKU_WASM` 是 `WebAssembly.Module`，需要手动实例化

3. **环境变量访问**:
   - Worker: 通过 `wrangler.toml` 的 `[vars]` 和 Secrets
   - Pages: 通过 Dashboard 的 Environment Variables 和 Functions Secrets

4. **代码结构**:
   - Pages Functions 使用 `onRequest` 导出处理函数
   - 使用 `context.waitUntil()` 处理异步任务

完整的 `functions/api/stream.ts` 已包含：
- WebSocket 升级处理
- WASM 实例化和会话初始化
- 上游 TCP 连接
- AEAD 加密/解密
- 数据流转发
```

### 步骤 4：准备静态页面

我们已经有完整的伪装前端 `index.html`（Sudoku Matrix Encoding & ASCII Research Lab），需要将其复制到 `static/` 目录：

```bash
# 创建 static 目录并复制伪装前端
mkdir -p static
cp index.html static/
```

或者手动复制项目根目录的 `index.html` 到 `static/index.html`。

这个伪装前端包含：
- 研究站主题界面
- 数独求解演示
- ASCII 编码工具
- 终端日志模拟
- API 文档展示

完美伪装成一个合法的学术研究网站。

### 步骤 5：配置 package.json

```json
{
  "name": "sudoku-wasm-pages",
  "version": "1.0.0",
  "scripts": {
    "dev": "wrangler pages dev",
    "deploy": "wrangler pages deploy"
  },
  "dependencies": {
    "@cloudflare/workers-types": "^4.20231218.0"
  },
  "devDependencies": {
    "wrangler": "^3.22.0"
  }
}
```

### 步骤 6：连接 GitHub 部署（使用 wrangler.toml）

**重要**: Pages 的 Git 集成会读取 `wrangler.toml` 中的配置，包括 WASM 模块绑定！

1. 确保仓库根目录有 `wrangler.toml`（已创建 `wrangler.pages.toml`，可重命名为 `wrangler.toml`）

2. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)

3. 进入 **Pages** → **Create a project**

4. 选择 **Connect to Git**

5. 选择 `coolapijust/sudoku-worker` 仓库

6. 配置构建设置：
   - **Framework preset**: None
   - **Build command**: 留空
   - **Build output directory**: `static`

7. 点击 **Save and Deploy**

> **WASM 模块**: 由于 `wrangler.toml` 中已配置 `[[wasm_modules]]`，Git 集成会自动处理 WASM 绑定。

### 步骤 7：设置 Secrets

部署完成后，在 Dashboard 中设置：

1. 进入 Pages 项目 → **Settings** → **Environment Variables**

2. 添加 **Secrets**（点击 **Encrypt**）：
   - `SUDOKU_KEY` = `cc6aff06410039f12142d6c2d633a99161513e1009a3e6a34f4bb3424d1b5c64`
   - `ED25519_PRIVATE_KEY` = `f517c12b7cb4fbea4e4d7167e1caae5ba0040be4e613e6a6d5884e598e3003d5`

3. 点击 **Save** 并重新部署

---

## 方式二：直接上传部署

### 步骤 1：准备文件

创建项目目录结构：

```
sudoku-pages/
├── functions/
│   └── api/
│       └── stream.ts
├── static/
│   └── index.html
├── sudoku.wasm
└── wrangler.toml
```

### 步骤 2：使用 Wrangler 部署

```bash
# 登录 Cloudflare
wrangler login

# 部署到 Pages
wrangler pages deploy . --project-name=sudoku-wasm-pages
```

### 步骤 3：设置 Secrets

```bash
# 设置 Secrets
wrangler pages secret put SUDOKU_KEY --project-name=sudoku-wasm-pages
# 输入: cc6aff06410039f12142d6c2d633a99161513e1009a3e6a34f4bb3424d1b5c64

wrangler pages secret put ED25519_PRIVATE_KEY --project-name=sudoku-wasm-pages
# 输入: f517c12b7cb4fbea4e4d7167e1caae5ba0040be4e613e6a6d5884e598e3003d5
```

---

## 方式三：使用 GitHub Actions 自动部署

### 创建 `.github/workflows/pages.yml`

```yaml
name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name=sudoku-wasm-pages
```

### 配置 GitHub Secrets

在 GitHub 仓库 → **Settings** → **Secrets and variables** → **Actions** 中添加：

- `CLOUDFLARE_API_TOKEN`: Cloudflare API Token
- `CLOUDFLARE_ACCOUNT_ID`: Cloudflare Account ID

### 获取 API Token

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 进入 **My Profile** → **API Tokens**
3. 点击 **Create Token**
4. 使用 **Custom token** 模板：
   - **Token name**: Pages Deploy
   - **Permissions**: 
     - `Cloudflare Pages:Edit`
     - `Account:Read`
   - **Account Resources**: Include your account
5. 点击 **Continue** → **Create Token**

---

## 访问部署后的服务

部署完成后，您将获得一个类似以下的 URL：

```
https://sudoku-wasm-pages.pages.dev
```

### 端点说明

| 路径 | 功能 |
|------|------|
| `/` | 静态页面（研究站） |
| `/api/stream` | WebSocket Sudoku 协议代理 |

---

## 与 Worker 部署的区别

| 特性 | Cloudflare Worker | Cloudflare Pages |
|------|-------------------|------------------|
| WASM 支持 | 通过 Wrangler CLI | 通过 Wrangler CLI 或 Git 集成 |
| 静态页面 | 需要额外配置 | 原生支持 |
| 自定义域名 | 支持 | 支持 |
| 部署方式 | Wrangler CLI | Git 集成、Wrangler CLI、直接上传 |
| 适合场景 | 纯 API/代理 | 全栈应用（前端 + API） |

---

## 故障排查

### 问题 1: WASM 模块未找到

**错误**: `WebAssembly.Module is not a constructor`

**解决**: 确保 `wrangler.toml` 中正确配置了 `[[wasm_modules]]`。

### 问题 2: Secrets 未生效

**错误**: `Secret not found`

**解决**: Pages 的 Secrets 在 Functions 标签页中设置，不是 Environment Variables。

### 问题 3: WebSocket 连接失败

**错误**: `Error in WebSocket connection`

**解决**: 确保 Functions 路由正确配置，返回 `status: 101` 和 `webSocket` 对象。
