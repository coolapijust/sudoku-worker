# Cloudflare Worker 手动部署指南

## 方式一：通过 Cloudflare Dashboard 部署（推荐）

### 步骤 1：创建 Worker

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 进入 **Workers & Pages**
3. 点击 **Create application**
4. 选择 **Create Worker**
5. 输入 Worker 名称（如 `sudoku-wasm-bridge`）
6. 点击 **Deploy**

### 步骤 2：上传文件

#### 方法 A：通过 Dashboard 上传

1. 在 Worker 详情页，点击 **Edit code**
2. 删除默认代码，将 `dist/index.js` 的内容粘贴进去
3. 点击 **Save and deploy**

#### 方法 B：通过 Wrangler CLI（如果本地 wrangler 可用）

```bash
# 安装依赖
npm install

# 编译 TypeScript
npx tsc

# 部署
wrangler deploy
```

### 步骤 3：上传 WASM 模块

1. 在 Worker 详情页，点击 **Settings** → **Variables**
2. 找到 **WASM modules** 部分
3. 点击 **Add module**
4. 上传 `sudoku.wasm` 文件
5. 模块名称填写：`SUDOKU_WASM`

### 步骤 4：设置环境变量

在 **Settings** → **Variables** 中设置以下变量：

#### 明文变量 (Variables)

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `UPSTREAM_HOST` | `127.0.0.1` | 上游服务器地址 |
| `UPSTREAM_PORT` | `8080` | 上游服务器端口 |
| `CIPHER_METHOD` | `chacha20-poly1305` | 加密方法 |
| `LAYOUT_MODE` | `ascii` | 布局模式 |
| `ED25519_PUBLIC_KEY` | *(留空)* | Ed25519 公钥 |
| `KEY_DERIVE_SALT` | `sudoku-v2-edge-salt` | 密钥派生盐值 |

#### 加密变量 (Secrets)

点击 **Edit variables** → **Add variable**，勾选 **Encrypt**:

| 变量名 | 值 |
|--------|-----|
| `SUDOKU_KEY` | `cc6aff06410039f12142d6c2d633a99161513e1009a3e6a34f4bb3424d1b5c64` |
| `ED25519_PRIVATE_KEY` | `f517c12b7cb4fbea4e4d7167e1caae5ba0040be4e613e6a6d5884e598e3003d5` |

### 步骤 5：绑定 WASM 模块

在 `wrangler.toml` 中，WASM 模块通过以下方式绑定：

```toml
[wasm_modules]
SUDOKU_WASM = "./sudoku.wasm"
```

在 Dashboard 中，这对应 **Settings** → **WASM modules** 部分。

---

## 方式二：通过 Git 集成部署

### 步骤 1：连接 GitHub 仓库

1. 在 Cloudflare Dashboard，进入 **Workers & Pages**
2. 点击 **Create application**
3. 选择 **Pages** 标签
4. 点击 **Connect to Git**
5. 授权 Cloudflare 访问 GitHub
6. 选择 `coolapijust/sudoku-worker` 仓库
7. 点击 **Begin setup**

### 步骤 2：配置构建设置

| 设置项 | 值 |
|--------|-----|
| **Project name** | `sudoku-wasm-bridge` |
| **Production branch** | `main` |
| **Build command** | `npm install && npx tsc` |
| **Build output directory** | `dist` |

### 步骤 3：设置环境变量

在构建设置页面，展开 **Environment variables**，添加：

```
UPSTREAM_HOST=127.0.0.1
UPSTREAM_PORT=8080
CIPHER_METHOD=chacha20-poly1305
LAYOUT_MODE=ascii
KEY_DERIVE_SALT=sudoku-v2-edge-salt
```

### 步骤 4：部署

点击 **Save and Deploy**

### 步骤 5：设置 Secrets（部署后）

1. 进入 Worker 详情页
2. 点击 **Settings** → **Variables**
3. 添加加密变量：
   - `SUDOKU_KEY`: `cc6aff06410039f12142d6c2d633a99161513e1009a3e6a34f4bb3424d1b5c64`
   - `ED25519_PRIVATE_KEY`: `f517c12b7cb4fbea4e4d7167e1caae5ba0040be4e613e6a6d5884e598e3003d5`

### 步骤 6：上传 WASM 模块

由于 Pages 不直接支持 WASM 模块上传，需要：

1. 在 Dashboard 创建一个新的 Worker（不是 Pages）
2. 按照 **方式一** 的步骤 3 上传 WASM 模块

---

## 方式三：直接通过 Workers 绑定 Git

### 步骤 1：创建 Worker with Git

1. 进入 **Workers & Pages** → **Create application**
2. 选择 **Workers** 标签
3. 点击 **Create Worker**
4. 在代码编辑器中，点击 **Deploy**
5. 然后点击 **Settings** → **Git integration**
6. 连接 GitHub 仓库

### 步骤 2：配置自动部署

连接 GitHub 后，每次推送代码到 main 分支会自动部署。

### 步骤 3：上传 WASM 模块

Git 集成不会自动上传 WASM 模块，需要手动：

1. 进入 Worker **Settings** → **WASM modules**
2. 上传 `sudoku.wasm`
3. 命名为 `SUDOKU_WASM`

### 步骤 4：设置 Secrets

在 **Settings** → **Variables** 中设置加密变量：
- `SUDOKU_KEY`
- `ED25519_PRIVATE_KEY`

---

## 验证部署

部署完成后，访问 Worker URL：

```
https://sudoku-wasm-bridge.<your-subdomain>.workers.dev
```

应该能看到研究站 HTML 页面。

测试 WebSocket 端点：

```javascript
const ws = new WebSocket('wss://sudoku-wasm-bridge.<your-subdomain>.workers.dev/v2/stream', 'sudoku-tcp-v1');
```

---

## 故障排查

### WASM 模块未找到

确保：
1. WASM 模块已上传到 **Settings** → **WASM modules**
2. 模块名称为 `SUDOKU_WASM`
3. `wrangler.toml` 中的配置正确

### 环境变量未设置

检查 **Settings** → **Variables** 中：
- 所有明文变量已添加
- Secrets 已加密并保存

### 编译错误

如果使用 Git 集成，确保：
- `package.json` 中的构建命令正确
- `tsconfig.json` 配置正确
- 所有依赖已安装

---

## 预定义的密钥

### SUDOKU_KEY (AEAD 对称密钥)
```
cc6aff06410039f12142d6c2d633a99161513e1009a3e6a34f4bb3424d1b5c64
```
- 32 字节 (64 字符 hex)
- 用于 ChaCha20-Poly1305 或 AES-GCM 加密

### ED25519_PRIVATE_KEY (Ed25519 私钥)
```
f517c12b7cb4fbea4e4d7167e1caae5ba0040be4e613e6a6d5884e598e3003d5
```
- 32 字节 (64 字符 hex)
- 用于 Worker 身份签名

**注意**：这些是示例密钥，生产环境请使用随机生成的密钥！
